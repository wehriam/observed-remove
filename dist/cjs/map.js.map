{"version":3,"sources":["../../src/map.js"],"names":["ObservedRemoveMap","EventEmitter","constructor","entries","options","maxAge","bufferPublishing","publishTimeout","pairs","Map","deletions","insertQueue","deleteQueue","key","value","set","Symbol","iterator","dequeue","setTimeout","publish","sync","flush","maxAgeString","Date","now","toString","padStart","id","delete","queue","dump","emit","process","skipFlush","insertions","has","pair","get","undefined","insertMessage","deleteMessage","push","message","clear","keys","forEach","callback","thisArg","bind","values","size"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from 'events';\nimport generateId from './generate-id';\n\ntype Options = {\n  maxAge?:number,\n  bufferPublishing?:number\n};\n\n/**\n * Class representing a Observed Remove Map\n *\n * Implements all methods and iterators of the native `Map` object in addition to the following.\n * See: {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map}\n */\nexport default class ObservedRemoveMap<K, V> extends EventEmitter {\n  declare maxAge: number;\n  declare bufferPublishing: number;\n  declare pairs: Map<K, Array<*>>;\n  declare deletions: Map<string, K>;\n  declare deleteQueue: Array<*>;\n  declare insertQueue: Array<*>;\n  declare publishTimeout: null | TimeoutID;\n\n  constructor(entries?: Iterable<[K, V]>, options?:Options = {}) {\n    super();\n    this.maxAge = typeof options.maxAge === 'undefined' ? 5000 : options.maxAge;\n    this.bufferPublishing = typeof options.bufferPublishing === 'undefined' ? 30 : options.bufferPublishing;\n    this.publishTimeout = null;\n    this.pairs = new Map();\n    this.deletions = new Map();\n    this.insertQueue = [];\n    this.deleteQueue = [];\n    if (!entries) {\n      return;\n    }\n    for (const [key, value] of entries) {\n      this.set(key, value);\n    }\n  }\n\n  /* :: @@iterator(): Iterator<[K, V]> { return ({}: any); } */\n  // $FlowFixMe: computed property\n  [Symbol.iterator]() {\n    return this.entries();\n  }\n\n  dequeue() {\n    if (this.publishTimeout) {\n      return;\n    }\n    if (this.bufferPublishing > 0) {\n      this.publishTimeout = setTimeout(() => this.publish(), this.bufferPublishing);\n    } else {\n      this.publish();\n    }\n  }\n\n  publish() {\n    this.publishTimeout = null;\n    const insertQueue = this.insertQueue;\n    const deleteQueue = this.deleteQueue;\n    this.insertQueue = [];\n    this.deleteQueue = [];\n    this.sync([insertQueue, deleteQueue]);\n  }\n\n  flush() {\n    const maxAgeString = (Date.now() - this.maxAge).toString(36).padStart(9, '0');\n    for (const [id] of this.deletions) {\n      if (id < maxAgeString) {\n        this.deletions.delete(id);\n      }\n    }\n  }\n\n  /**\n   * Emit a 'publish' event containing a specified queue or all of the set's insertions and deletions.\n   * @param {Array<Array<any>>} queue - Array of insertions and deletions\n   * @return {void}\n   */\n  sync(queue?: [Array<*>, Array<*>] = this.dump()) {\n    this.emit('publish', queue);\n  }\n\n  /**\n   * Return an array containing all of the map's insertions and deletions.\n   * @return {[Array<*>, Array<*>]>}\n   */\n  dump():[Array<*>, Array<*>] {\n    return [[...this.pairs], [...this.deletions]];\n  }\n\n  process(queue:[Array<*>, Array<*>], skipFlush?: boolean = false) {\n    const [insertions, deletions] = queue;\n    for (const [id, key] of deletions) {\n      this.deletions.set(id, key);\n    }\n    for (const [key, [id, value]] of insertions) {\n      if (this.deletions.has(id)) {\n        continue;\n      }\n      const pair = this.pairs.get(key);\n      if (!pair || (pair && pair[0] < id)) {\n        if (typeof value === 'undefined') {\n          this.pairs.set(key, [id]);\n        } else {\n          this.pairs.set(key, [id, value]);\n        }\n        this.emit('set', key, value, pair && pair[1] ? pair[1] : undefined);\n      } else if (pair && pair[0] === id) {\n        this.emit('affirm', key, value, pair ? pair[1] : undefined);\n      }\n    }\n    for (const [id, key] of deletions) {\n      const pair = this.pairs.get(key);\n      if (pair && pair[0] === id) {\n        this.pairs.delete(key);\n        this.emit('delete', key, pair[1]);\n      }\n    }\n    if (!skipFlush) {\n      this.flush();\n    }\n  }\n\n  set(key:K, value:V, id?: string = generateId()) {\n    const pair = this.pairs.get(key);\n    const insertMessage = typeof value === 'undefined' ? [key, [id]] : [key, [id, value]];\n    if (pair) {\n      const deleteMessage = [pair[0], key];\n      this.process([[insertMessage], [deleteMessage]], true);\n      this.deleteQueue.push(deleteMessage);\n    } else {\n      this.process([[insertMessage], []], true);\n    }\n    this.insertQueue.push(insertMessage);\n    this.dequeue();\n    return this;\n  }\n\n  get(key:K): V | void { // eslint-disable-line consistent-return\n    const pair = this.pairs.get(key);\n    if (pair) {\n      return pair[1];\n    }\n  }\n\n  delete(key:K):void {\n    const pair = this.pairs.get(key);\n    if (pair) {\n      const message = [pair[0], key];\n      this.process([[], [message]], true);\n      this.deleteQueue.push(message);\n      this.dequeue();\n    }\n  }\n\n  clear(): void {\n    for (const key of this.keys()) {\n      this.delete(key);\n    }\n  }\n\n  * entries():Iterator<[K, V]> {\n    for (const [key, [id, value]] of this.pairs) { // eslint-disable-line no-unused-vars\n      yield [key, value];\n    }\n  }\n\n  forEach(callback:Function, thisArg?:any):void {\n    if (thisArg) {\n      for (const [key, value] of this.entries()) {\n        callback.bind(thisArg)(value, key, this);\n      }\n    } else {\n      for (const [key, value] of this.entries()) {\n        callback(value, key, this);\n      }\n    }\n  }\n\n  has(key:K): boolean {\n    return !!this.pairs.get(key);\n  }\n\n  keys():Iterator<K> {\n    return this.pairs.keys();\n  }\n\n  * values():Iterator<V> {\n    for (const [id, value] of this.pairs.values()) { // eslint-disable-line no-unused-vars\n      yield value;\n    }\n  }\n\n  get size():number {\n    return this.pairs.size;\n  }\n}\n\n"],"file":"map.js"}